
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER FUNCTIONS
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function getUserData(uid) {
      // Use exists() to safely check for document existence
      return exists(/databases/$(database)/documents/users/$(uid))
        ? get(/databases/$(database)/documents/users/$(uid)).data
        : null;
    }

    function isRole(uid, role) {
      let userData = getUserData(uid);
      return isSignedIn() && userData != null && userData.role == role;
    }

    function isAdmin(uid) {
      return isRole(uid, 'admin');
    }

    function isTeacher(uid) {
      return isRole(uid, 'teacher');
    }

    function isStudent(uid) {
      return isRole(uid, 'student');
    }
    
    //----------------------------------------------------------------------
    //  USER PROFILE RULES
    //----------------------------------------------------------------------
    match /users/{uid} {
      // READ: Users can read their own profile. Admins can read any profile.
      // Teachers CANNOT read student profiles to protect private data like bank details.
      allow get: if isOwner(uid) || isAdmin(request.auth.uid);
      
      // LIST: Only admins can list all users to protect user privacy.
      // A user can query their own referral code
      allow list: if isAdmin(request.auth.uid) || (isSignedIn() && request.query.keys().hasOnly(['where', 'limit']));


      // CREATE: A user can only create their own profile document.
      // - The role must be 'student' or 'teacher' (admins are created manually).
      allow create: if isOwner(uid) 
                    && request.resource.data.uid == request.auth.uid
                    && (request.resource.data.role == 'student' || request.resource.data.role == 'teacher');
                    
      // UPDATE:
      // - Users can update their own profile, but cannot change their role, uid, email, or createdAt.
      // - Admins can update any field on any user profile.
      allow update: if (isOwner(uid) 
                      && request.resource.data.role == resource.data.role
                      && request.resource.data.uid == resource.data.uid
                      && request.resource.data.email == resource.data.email
                      && request.resource.data.createdAt == resource.data.createdAt
                    ) || isAdmin(request.auth.uid);

      // DELETE: Only admins can delete user profiles.
      allow delete: if isAdmin(request.auth.uid);
    }
    
    //----------------------------------------------------------------------
    //  REFERRAL RULES
    //----------------------------------------------------------------------
    match /referrals/{referralId} {
      // READ: A user can read a referral document if they are the referrer or the one referred.
      allow read: if isSignedIn() && (isOwner(resource.data.referrerId) || isOwner(resource.data.referredId));
      
      // CREATE: A user can only create a referral document where they are the one being referred.
      allow create: if isSignedIn() && isOwner(request.resource.data.referredId);
      
      // LIST: Allow users to query referrals they made or received.
      allow list: if isSignedIn();

      // UPDATE: Referrer can update the doc to claim their discount, one-way change only.
      allow update: if isOwner(resource.data.referrerId) &&
                     request.resource.data.referrerDiscountClaimed == true &&
                     resource.data.referrerDiscountClaimed != true &&
                     request.resource.data.referrerId == resource.data.referrerId &&
                     request.resource.data.referredId == resource.data.referredId;
      
      // DELETE: No deletes allowed from the client.
      allow delete: if false;
    }
    
    //----------------------------------------------------------------------
    //  DISCOUNT RULES
    //----------------------------------------------------------------------
    match /discounts/{discountId} {
        function getReferral(refId) {
            return get(/databases/$(database)/documents/referrals/$(refId));
        }
        function referralExists(refId) {
            return exists(/databases/$(database)/documents/referrals/$(refId));
        }

        // READ: Users can only read their own discounts.
        allow read: if isOwner(resource.data.userId);
        allow list: if isSignedIn() && request.query.where[0][0] == 'userId' && request.query.where[0][2] == request.auth.uid;

        // CREATE: Discount creation is heavily restricted.
        allow create: if isOwner(request.resource.data.userId) &&
                        request.resource.data.used == false &&
                        referralExists(request.resource.data.createdFromReferralId) &&
                        (
                          // Case 1: New user creating their 10% discount during signup.
                          (
                            request.resource.data.type == 'REFERRAL_NEW_USER' &&
                            request.resource.data.percentage == 10 &&
                            getReferral(request.resource.data.createdFromReferralId).data.referredId == request.auth.uid
                          ) ||
                          // Case 2: Referrer claiming their 30% discount from the dashboard.
                          (
                            request.resource.data.type == 'REFERRAL_OWNER' &&
                            request.resource.data.percentage == 30 &&
                            getReferral(request.resource.data.createdFromReferralId).data.referrerId == request.auth.uid &&
                            getReferral(request.resource.data.createdFromReferralId).data.referrerDiscountClaimed != true
                          )
                        );
        
        // UPDATE: Only to mark a discount as used during a purchase. One-way change.
        allow update: if isOwner(resource.data.userId) &&
                         resource.data.used == false && // Can only be used once
                         request.resource.data.used == true &&
                         request.resource.data.keys().hasAll(['used', 'orderId']) && // Must include orderId to link to purchase
                         // Verify that a corresponding ticket exists and uses this discount ID
                         get(/databases/$(database)/documents/tickets/$(request.resource.data.orderId)).data.studentId == request.auth.uid &&
                         get(/databases/$(database)/documents/tickets/$(request.resource.data.orderId)).data.appliedDiscountId == discountId;

        // DELETE: Not allowed from client.
        allow delete: if false;
    }


    //----------------------------------------------------------------------
    //  PUBLIC TUTOR PROFILE RULES
    //----------------------------------------------------------------------
    match /tutors/{tutorId} {
      // READ: Any authenticated user can view public tutor profiles.
      allow read: if isSignedIn();
      // WRITE: Only the owner of the profile can create or update it.
      allow write: if isOwner(tutorId);
    }

    //----------------------------------------------------------------------
    //  MEETING RULES
    //----------------------------------------------------------------------
    match /meetings/{meetingId} {
      // Teachers/Admins can create/update meetings. Signed-in users can read.
      allow read: if isSignedIn();
      allow write: if isTeacher(request.auth.uid) || isAdmin(request.auth.uid);
    }
    
    //----------------------------------------------------------------------
    //  TICKET RULES
    //----------------------------------------------------------------------
    match /tickets/{ticketId} {
        // READ (get): 
        // - Admins can read any ticket.
        // - A user (student or teacher) can read a ticket if their UID is on it.
        allow get: if isAdmin(request.auth.uid) || 
                    (isSignedIn() && (isOwner(resource.data.studentId) || isOwner(resource.data.teacherId)));

        // LIST: 
        // - Admins can list all tickets.
        // - Students can list tickets where their studentId matches.
        // - Teachers can list tickets where their teacherId matches.
        allow list: if isAdmin(request.auth.uid) ||
                     (isStudent(request.auth.uid) && request.query.get("studentId") == request.auth.uid) ||
                     (isTeacher(request.auth.uid) && request.query.get("teacherId") == request.auth.uid);

        // CREATE: Only students can create tickets for themselves.
        allow create: if isStudent(request.auth.uid) && request.resource.data.studentId == request.auth.uid;

        // UPDATE:
        // - Student can update status to 'WAITING_FOR_TEACHER' and perform the one-time 'check-in'.
        // - Teacher can update status to 'ACTIVE', 'COMPLETED', or 'CANCELLED'.
        // - Admins can update anything.
        // - Core fields are immutable.
        allow update: if 
          // Student actions
          (
            isStudent(request.auth.uid) && isOwner(resource.data.studentId) &&
            (
              // Allow entering waiting room
              (request.resource.data.status == 'WAITING_FOR_TEACHER' && resource.data.status == 'PAID') ||
              // Allow the one-time check-in
              (request.resource.data.used == true && resource.data.used == false && request.resource.data.checkInTime != null)
            ) &&
            // Immutable fields
            request.resource.data.studentId == resource.data.studentId &&
            request.resource.data.teacherId == resource.data.teacherId &&
            request.resource.data.createdAt == resource.data.createdAt &&
            request.resource.data.orderId == resource.data.orderId
          )
        || 
          // Teacher actions
          (
            isTeacher(request.auth.uid) && isOwner(resource.data.teacherId) && 
            (
              request.resource.data.status == 'ACTIVE' || 
              request.resource.data.status == 'COMPLETED' || 
              request.resource.data.status == 'CANCELLED' ||
              request.resource.data.status == 'REFUND_PROCESSED'
            ) &&
            // Immutable fields
            request.resource.data.studentId == resource.data.studentId &&
            request.resource.data.teacherId == resource.data.teacherId &&
            request.resource.data.createdAt == resource.data.createdAt &&
            request.resource.data.orderId == resource.data.orderId &&
            request.resource.data.used == resource.data.used
          ) 
        || 
          // Admin can do anything
          isAdmin(request.auth.uid);

        // DELETE: No one can delete tickets, for auditing.
        allow delete: if false;
    }

    match /participants/{meetingRoomId}/{presence=**} {
      allow read, write: if isSignedIn();
    }
    
    //----------------------------------------------------------------------
    //  WHITEBOARD RULES
    //----------------------------------------------------------------------
    match /whiteboards/{meetingId}/strokes/{strokeId} {
      allow read, write: if isSignedIn(); 
    }

    //----------------------------------------------------------------------
    //  COURSES & TOPICS RULES
    //----------------------------------------------------------------------
    match /courses/{courseId} {
      allow read: if isSignedIn();
      allow write: if isTeacher(request.auth.uid);
    }

    match /topics/{topicId} {
      allow read: if isSignedIn();
      allow create: if isTeacher(request.auth.uid) && request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isTeacher(request.auth.uid) && resource.data.createdBy == request.auth.uid;
    }
  }
}
