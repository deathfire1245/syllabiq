
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // HELPER FUNCTIONS
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }

    function isRole(uid, role) {
      return isSignedIn() && getUserData(uid).role == role;
    }

    function isAdmin(uid) {
      return isRole(uid, 'admin');
    }

    function isTeacher(uid) {
      return isRole(uid, 'teacher');
    }

    function isStudent(uid) {
      return isRole(uid, 'student');
    }
    
    //----------------------------------------------------------------------
    //  USER PROFILE RULES
    //----------------------------------------------------------------------
    match /users/{uid} {
      // READ: Users can read their own profile. Admins can read any profile. Teachers can read student profiles (for sessions).
      allow get: if isOwner(uid) || isAdmin(request.auth.uid) || (isTeacher(request.auth.uid));
      
      // LIST: Only admins can list all users.
      allow list: if isAdmin(request.auth.uid);

      // CREATE: A user can only create their own profile document.
      // - The UID must match the authenticated user.
      // - The role must be 'student' or 'teacher' (admins are created manually).
      allow create: if isOwner(uid) 
                    && request.resource.data.uid == request.auth.uid
                    && (request.resource.data.role == 'student' || request.resource.data.role == 'teacher');
                    

      // UPDATE:
      // - Users can update their own profile.
      // - Users CANNOT change their own role, uid, email, or createdAt fields.
      // - Admins can update any field on any user profile.
      allow update: if (isOwner(uid) 
                      && request.resource.data.role == resource.data.role
                      && request.resource.data.uid == resource.data.uid
                      && request.resource.data.email == resource.data.email
                      && request.resource.data.createdAt == resource.data.createdAt
                    ) || isAdmin(request.auth.uid);

      // DELETE: Only admins can delete user profiles.
      allow delete: if isAdmin(request.auth.uid);
    }
    
    //----------------------------------------------------------------------
    //  MEETING RULES
    //----------------------------------------------------------------------
    match /meetings/{meetingId} {
      // Teachers/Admins can create/update meetings. Signed-in users can read.
      allow read: if isSignedIn();
      allow write: if isTeacher(request.auth.uid) || isAdmin(request.auth.uid);
    }
    
    //----------------------------------------------------------------------
    //  TICKET RULES
    //----------------------------------------------------------------------
    match /tickets/{ticketId} {
        // READ: Student who owns it, teacher assigned to it, or an admin can read.
        allow get: if isSignedIn() && (isOwner(resource.data.studentId) || isOwner(resource.data.teacherId) || isAdmin(request.auth.uid));

        // LIST: 
        // - Students can list their own tickets.
        // - Teachers can list their own tickets. They can also specifically query for waiting students.
        // - Admins can list all tickets.
        allow list: if isSignedIn() && 
                    (
                      (isStudent(request.auth.uid) && request.query.where.studentId == request.auth.uid) ||
                      (isTeacher(request.auth.uid) && request.query.where.teacherId == request.auth.uid) ||
                      (isTeacher(request.auth.uid) && request.query.where.teacherId == request.auth.uid && request.query.where.status == 'WAITING_FOR_TEACHER') ||
                      isAdmin(request.auth.uid)
                    );

        // CREATE: Only students can create tickets for themselves.
        // Exception: Any user can create a ticket for the test meeting room.
        allow create: if (isStudent(request.auth.uid) && request.resource.data.studentId == request.auth.uid)
                      || (isSignedIn() && request.resource.data.teacherId == 'test-teacher-id');

        // UPDATE:
        // - Student can only update status to 'WAITING_FOR_TEACHER'.
        // - Teacher can only update status to 'ACTIVE', 'COMPLETED', or 'CANCELLED'.
        // - Admins can update anything.
        allow update: if (isStudent(request.auth.uid) && isOwner(resource.data.studentId) && request.resource.data.status == 'WAITING_FOR_TEACHER')
                      || (isTeacher(request.auth.uid) && isOwner(resource.data.teacherId) && (request.resource.data.status == 'ACTIVE' || request.resource.data.status == 'COMPLETED' || request.resource.data.status == 'CANCELLED'))
                      || isAdmin(request.auth.uid);

        // DELETE: No one can delete tickets, for auditing.
        allow delete: if false;
    }

    match /participants/{meetingRoomId}/{presence=**} {
      allow read, write: if isSignedIn();
    }
    
    //----------------------------------------------------------------------
    //  WHITEBOARD RULES
    //----------------------------------------------------------------------
    match /whiteboards/{meetingId}/{documents=**} {
      allow read, write: if isSignedIn(); // Allow any authenticated user in the meeting to interact
    }
  }
}
